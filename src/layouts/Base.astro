---
import Head from '@layouts/Head.astro'
import Header from '@layouts/Header.astro'
import Footer from '@layouts/Footer.astro'
import { useStoryblokApi } from '@storyblok/astro'
import TitleHidden from '@blocks/TitleHidden.astro'
import {
	_addAwards,
	_addPeople,
	_addDesignations,
	_addOffices,
	_addSectors,
	_addPractices,
	_addAfricaPractices,
	_addInsights,
	_addCategories,
	_addEvents,
	_addNewsletter,
} from '@scripts/store'
import Shim from '@blocks/Shim.astro'
import Modal from '@blocks/Modal.astro'
import ModalNewsletter from '@blocks/ModalNewsletter.astro'
import _startsWith from '@scripts/starts-with'
import Drapery from '@blocks/Drapery.astro'

const currentYear = new Date().getFullYear(),
	lastYear = currentYear - 1,
	{ pageTitle, pageDescription, pageThumbnail } = Astro.props,
	api = useStoryblokApi(),
	{ data: settings } = await api.get('cdn/stories/settings', {
		version: import.meta.env.DEV ? 'draft' : 'published',
		resolve_links: 'url',
		resolve_relations: [
			'settings.awards',
			'settings.links',
			'settings.socials',
		],
	}),
	site = settings.story.content,
	{ data: dataNewsletter } = await api.get('cdn/stories/global/newsletter', {
		version: import.meta.env.DEV ? 'draft' : 'published',
	}),
	newsletter = dataNewsletter.story.content

let fixHeader = true,
	currPath = Astro.url.pathname,
	unfixHeader = ['about', 'people', 'insights', 'events']

if (currPath == '/')
	currPath = currPath.replace(/^\//, 'home').replace(/\.html$/, '')
else currPath = currPath.replace(/^\//, '').replace(/\.html$/, '')

_startsWith(currPath, unfixHeader) ? (fixHeader = false) : (fixHeader = true)

const calls = [

]

// const t0 = performance.now()
let { data: awards } = await api.get('cdn/stories', {
		starts_with: 'awards/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		by_slugs: [`awards/${currentYear}/*`, `awards/${lastYear}/*`],
		level: 3,
		is_startpage: false,
	}),
	{ data: dataDesignations } = await api.get('cdn/stories', {
		starts_with: 'designations/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
	}),
	{ data: dataCategories } = await api.get('cdn/stories', {
		starts_with: 'category/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
	}),
	{ data: dataOffices } = await api.get('cdn/stories', {
		starts_with: 'offices/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		sort_by: 'content.order:asc',
		resolve_links: 'url',
		resolve_relations: ['office.contacts'],
	}),
	{ data: dataPeople } = await api.get('cdn/stories', {
		starts_with: 'people/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		resolve_links: 'url',
		resolve_relations: [
			'person.byline',
			'person_links.location',
			'collection.collection',
		],
	}),
	{ data: dataSectors } = await api.get('cdn/stories', {
		starts_with: 'sectors/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		resolve_links: 'url',
		sort_by: 'content.title:asc',
	}),
	{ data: dataPractices } = await api.get('cdn/stories', {
		starts_with: 'practices/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		resolve_links: 'url',
		sort_by: 'content.title:asc',
	}),
	{ data: dataAfricaPractices } = await api.get('cdn/stories', {
		starts_with: 'africa-expertise/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		resolve_links: 'url',
		sort_by: 'content.title:asc',
	}),
	{ data: dataInsights } = await api.get('cdn/stories', {
		starts_with: 'insights/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		sort_by: 'content.published_date:desc',
		resolve_links: 'url',
		resolve_relations: [
			'insight.category',
			'insight.author',
			'insight.expertise',
		],
	}),
	{ data: dataEvents } = await api.get('cdn/stories', {
		starts_with: 'events/',
		version: import.meta.env.DEV ? 'draft' : 'published',
		is_startpage: false,
		sort_by: 'content.start_date:desc',
		resolve_links: 'url',
		resolve_relations: ['session.host', 'panelist.person'],
	})

let people = dataPeople.stories,
	designations = dataDesignations.stories,
	offices = dataOffices.stories,
	sectors = dataSectors.stories,
	practices = dataPractices.stories,
	africaPractices = dataAfricaPractices.stories,
	insights = dataInsights.stories,
	categories = dataCategories.stories,
	events = dataEvents.stories

_addAwards(awards)
_addPeople(people)
_addDesignations(designations)
_addOffices(offices)
_addSectors(sectors)
_addPractices(practices)
_addAfricaPractices(africaPractices)
_addInsights(insights)
_addCategories(categories)
_addEvents(events)
_addNewsletter(newsletter)
// const t1 = performance.now()

// console.log('t1 - t0 = ', t1 - t0)
---

<!doctype html>
<html lang='en' class='scroll-smooth bg-[var(--color-bg-default)]'>
	<Head
		title={`${pageTitle} | ${site.title}`}
		description={pageDescription || site.description}
		image={pageThumbnail || '/thumbnail.png'}
	/>
	<body
		class='max-w-screen-3xl mx-auto flex flex-col min-h-screen overflow-x-hidden'>
		<TitleHidden tag='h1' title={pageTitle} id='title-hidden' />
		<Header
			nav={site.nav}
			tools={site.tools}
			class:list={[fixHeader && 'fixed inset-x-0 top-0']}
			id='header'
		/>
		<main
			class:list={[
				'mb-auto swup-in',
				fixHeader &&
					'pt-[var(--spacing-1)] md:pt-[var(--spacing-2)] lg:pt-[var(--spacing-3)]',
			]}
			id='swup'>
			<slot />
		</main>
		<Footer site={site} id='footer' />
        <Drapery data-drapery>

        </Drapery>
		<Modal data-modal>
			<ModalNewsletter data-modal-display='newsletter' />
		</Modal>
		<Shim data-shim />
		<script src='@scripts/global.js'></script>
	</body>
</html>
