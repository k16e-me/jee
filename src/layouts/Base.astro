---
import Head from '@layouts/Head.astro'
import Header from '@layouts/Header.astro'
import Footer from '@layouts/Footer.astro'
import { useStoryblokApi } from '@storyblok/astro'
import TitleHidden from '@blocks/TitleHidden.astro'
import {
	_addAwards,
	_awards,
	_people,
	_addPeople,
	_designtions,
	_addDesignations,
	_offices,
	_addOffices,
} from '@scripts/store'

const currentYear = new Date().getFullYear(),
	lastYear = currentYear - 1,
	{ pageTitle, pageDescription, pageThumbnail, showNav, isError } =
		Astro.props,
	api = useStoryblokApi(),
	{ data: settings } = await api.get('cdn/stories/settings', {
		version: import.meta.env.DEV ? 'draft' : 'published',
		resolve_links: 'url',
		resolve_relations: [
			'settings.awards',
			'settings.links',
			'settings.socials',
		],
	}),
	site = settings.story.content

let { data: awards } = await api.get('cdn/stories', {
	starts_with: 'awards/',
	version: import.meta.env.DEV ? 'draft' : 'published',
	by_slugs: [`awards/${currentYear}/*`, `awards/${lastYear}/*`],
	level: 3,
	is_startpage: 0,
})
let { data: dataDesignations } = await api.get('cdn/stories', {
	starts_with: 'designations/',
	version: import.meta.env.DEV ? 'draft' : 'published',
	is_startpage: 0,
})
let { data: dataOffices } = await api.get('cdn/stories', {
	starts_with: 'offices/',
	version: import.meta.env.DEV ? 'draft' : 'published',
	is_startpage: 0,
})
let { data: dataPeople } = await api.get('cdn/stories', {
	starts_with: 'people/',
	version: import.meta.env.DEV ? 'draft' : 'published',
	is_startpage: 0,
	resolve_links: 'url',
	resolve_relations: ['person.byline', 'person_links.location'],
})
let people = dataPeople.stories
let designations = dataDesignations.stories
let offices = dataOffices.stories

_addAwards(awards)
_addPeople(people)
_addDesignations(designations)
_addOffices(offices)
---

<!doctype html>
<html lang='en' class='scroll-smooth bg-[var(--color-bg-default)]'>
	<Head
		title={`${pageTitle} | ${site.title}`}
		description={pageDescription || site.description}
		image={pageThumbnail || '/thumbnail.png'}
	/>
	<body class='max-w-screen-3xl mx-auto flex flex-col min-h-screen'>
		<TitleHidden tag='h2' title={pageTitle} />
		<Header nav={site.nav} tools={site.tools} />
		<main class='mb-auto swup-in' id='swup'>
			<slot />
		</main>
		<Footer site={site} />
		<script src='@scripts/global.js'></script>
	</body>
</html>
