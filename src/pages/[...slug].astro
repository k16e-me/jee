---
import { useStoryblokApi } from '@storyblok/astro'
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro'
import Base from '@layouts/Base.astro'

export async function getStaticPaths() {
	const storyblokApi = useStoryblokApi()

	let links = await storyblokApi.getAll('cdn/links', {
		version: import.meta.env.DEV ? 'draft' : 'published',
	})
	links = Object.values(links).filter(
		(link) =>
			!(link.slug === 'settings') &&
			!link.slug.startsWith('global') &&
			!link.slug.startsWith('awards') &&
			!link.slug.startsWith('designations') &&
			!link.slug.startsWith('profiles') &&
			!link.slug.startsWith('category') &&
			!link.slug.startsWith('successes') &&
			!link.slug.startsWith('offices') &&
			!link.slug.startsWith('regions') &&
			!link.slug.startsWith('legal'),
	)

	return links
		.filter((link) => !link.is_folder)
		.map((link) => {
			return {
				params: { slug: link.slug === 'home' ? undefined : link.slug },
			}
		})
}

const { slug } = Astro.params,
	storyblokApi = useStoryblokApi(),
	{ data } = await storyblokApi.get(
		`cdn/stories/${slug === undefined ? 'home' : slug}`,
		{
			version: import.meta.env.DEV ? 'draft' : 'published',
			resolve_links: 'url',
			resolve_relations: [
				'block_bento_plaques.plaques',
				'image_hanging_insight.insight',
				'carousel_people.people',
				'person.byline',
				'person_links.location',
				'collection.collection',
				'section_latest.insights',
				'insight.category',
				'insight.author',
				'insight.expertise',
				'session.host',
				'panelist.person',
				'chairpersons.persons',
			],
		},
	),
	page = data.story,
	content = page.content,
	seo = content.seo[0]
---

<Base
	pageTitle={seo.title}
	pageDescription={seo.description}
	pageThumbnail={seo.thumbnail.filename}>
	<StoryblokComponent blok={content} />
</Base>
