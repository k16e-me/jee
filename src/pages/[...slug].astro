---
import { useStoryblokApi } from '@storyblok/astro'
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro'
import Base from '@layouts/Base.astro'

// Let Astro know what routes to build
export async function getStaticPaths() {
	const storyblokApi = useStoryblokApi()

	let links = await storyblokApi.getAll('cdn/links', {
		version: import.meta.env.DEV ? 'draft' : 'published',
	})
	links = Object.values(links).filter(
		(link) =>
			!(link.slug === 'settings') &&
			!link.slug.includes('global/') &&
			!link.slug.includes('awards/') &&
			!link.slug.includes('designations/') &&
			!link.slug.includes('profiles/') &&
			!link.slug.includes('category/') &&
			!link.slug.includes('successes/') &&
			!link.slug.includes('offices/') &&
			!link.slug.includes('regions/') &&
			!link.slug.includes('legal/') &&
			!link.slug.includes('events/') &&
			!link.slug.includes('previews/')
	)

	return links
		.filter((link) => !link.is_folder)
		.map((link) => {
			return {
				params: {
					slug: link.slug === 'home' ? undefined : link.slug
				}
			}
		})
}

// Pull slug from the routes and corresponding content/blocks from Storyblok
const { slug } = Astro.params,
	storyblokApi = useStoryblokApi(),
	{ data } = await storyblokApi.get(
		`cdn/stories/${slug === undefined ? 'home' : slug}`,
		{
			version: import.meta.env.DEV ? 'draft' : 'published',
			resolve_links: 'url',
			resolve_relations: [
				'block_bento_plaques.plaques',
				'image_hanging_insight.insight',
				'insight.author',
				'carousel_people.people',
				'person.byline',
				'section_latest.insights',
				'insight.category',
				'insight.expertise',
			],
		},
	),
	page = data.story,
	content = page.content,
	seo = content.seo[0]
---

<Base
	pageTitle={seo.title}
	pageDescription={seo.description}
	pageThumbnail={seo.thumbnail.filename}>
	<StoryblokComponent blok={content} />
</Base>
